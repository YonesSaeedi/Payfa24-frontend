name: React Panel Deployment

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy
        shell: bash
        run: |
          set -e

          case "${GITHUB_REF}" in
            refs/heads/main)
              BRANCH="main"
              TARGET_DIR="/home/payfa24/domains/payfa24.org/panel/main"
              CONTAINER_NAME="react-main"
              PORT=3200
              ;;
            refs/heads/dev)
              BRANCH="dev"
              TARGET_DIR="/home/payfa24/domains/payfa24.org/panel/dev"
              CONTAINER_NAME="react-dev"
              PORT=3300
              ;;
            *)
              exit 0
              ;;
          esac

          ssh -T -o StrictHostKeyChecking=no -p 3031 root@45.159.114.231 << 'EOF'
            set -e

            cd '"$TARGET_DIR"'

            git fetch origin
            git reset --hard origin/'"$BRANCH"'
            git clean -fdx

            docker stop '"$CONTAINER_NAME"' 2>/dev/null || true
            docker rm '"$CONTAINER_NAME"' 2>/dev/null || true

            docker build --no-cache -t '"$CONTAINER_NAME"':latest .
