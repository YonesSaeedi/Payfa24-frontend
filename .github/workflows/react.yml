name: React Panel Deployment

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Set variables
        shell: bash
        run: |
          if [[ "$GITHUB_REF" == "refs/heads/main" ]]; then
            echo "BRANCH=main" >> $GITHUB_ENV
            echo "TARGET_DIR=/home/payfa24/domains/payfa24.org/panel/main" >> $GITHUB_ENV
            echo "CONTAINER_NAME=react-main" >> $GITHUB_ENV
            echo "PORT=3200" >> $GITHUB_ENV
          else
            echo "BRANCH=dev" >> $GITHUB_ENV
            echo "TARGET_DIR=/home/payfa24/domains/payfa24.org/panel/dev" >> $GITHUB_ENV
            echo "CONTAINER_NAME=react-dev" >> $GITHUB_ENV
            echo "PORT=3300" >> $GITHUB_ENV
          fi

      - name: Deploy to Server
        shell: bash
        run: |
          ssh -o StrictHostKeyChecking=no -p 3031 root@45.159.114.231 << EOF
            set -e
            cd \$TARGET_DIR

            echo "Updating code"
            git fetch origin
            git reset --hard origin/\$BRANCH
            git clean -fdx

            echo "Stopping old container"
            docker stop \$CONTAINER_NAME 2>/dev/null || true
            docker rm \$CONTAINER_NAME 2>/dev/null || true

            echo "Building new Docker image"
            docker build --no-cache -t \$CONTAINER_NAME:latest .

            echo "Starting container"
            docker run -d \
              --name \$CONTAINER_NAME \
              -p \$PORT:80 \
              --restart unless-stopped \
              \$CONTAINER_NAME:latest

            echo "Cleaning up dangling images"
            docker image prune -f
          EOF
